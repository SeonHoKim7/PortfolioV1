<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.PortfolioV1.comment.model.CommentMapper">

    <!-- comment 테이블 컬럼 정의 -->
    <sql id="commentColumns">
        id,
        board_id,
        comment_content,
        writer,
        delete_yn,
        created_date,
        modified_date
    </sql>

    <!-- 댓글 저장 -->
    <insert id="save"
            parameterType="com.example.PortfolioV1.comment.dto.CommentRequest"
            useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO comment (
            board_id,
            comment_content,
            writer,
            delete_yn,
            created_date,
            modified_date
        ) VALUES (
                     #{boardId},
                     #{commentContent},
                     #{writer},
                     0,
                     NOW(),
                     NULL
                 )
    </insert>

    <!-- 댓글 상세조회 -->
    <select id="findById"
            parameterType="long"
            resultType="com.example.PortfolioV1.comment.dto.CommentResponse">
        SELECT
        <include refid="commentColumns" />
        FROM comment
        WHERE id = #{value}
    </select>

    <!-- 댓글 수정 -->
    <update id="update"
            parameterType="com.example.PortfolioV1.comment.dto.CommentRequest">
        UPDATE comment
        SET
            comment_content = #{commentContent},
            writer         = #{writer},
            modified_date  = NOW()
        WHERE id = #{id}
    </update>

    <!-- 댓글 삭제 -->
    <delete id="deleteById"
            parameterType="long">
        UPDATE comment
        SET delete_yn = 1
        WHERE id = #{value}
    </delete>

    <!-- 댓글 리스트 조회 -->
    <select id="findAll"
            parameterType="com.example.PortfolioV1.comment.dto.CommentSearchDto"
            resultType="com.example.PortfolioV1.comment.dto.CommentResponse">
        SELECT
        <include refid="commentColumns" />
        FROM comment
        WHERE delete_yn = 0
        AND board_id   = #{boardId}
        ORDER BY id DESC
        LIMIT #{pagination.limitStart}, #{boardPerPage}
    </select>

    <!--  댓글 수 카운트  -->
    <select id="count" parameterType="com.example.PortfolioV1.comment.dto.CommentSearchDto" resultType="int">
        SELECT
            COUNT(*)
        FROM
            comment
        WHERE
            delete_yn = 0
            AND board_id = #{boardId}
    </select>
</mapper>
