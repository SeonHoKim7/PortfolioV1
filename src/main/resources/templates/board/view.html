<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common :: head('게시글 조회')}">
  <!-- 부트스트랩 CDN 추가 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>

<!-- 네비게이션 바 (기존 코드 유지) -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary" th:replace="~{fragments/common :: menu}"></nav>

    <div class="container mt-4">
      <h1 class="mb-4 text-center">게시글 상세보기</h1>

      <!-- 게시글 정보 -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-5" id="title"></h5>
          <p class="card-text mb-4">작성자: <span id="writer"></span></p>
          <p class="card-text mb-4">내용: <span id="content"></span></p>
          <p class="card-text mb-4">작성일: <span id="createdDate"></span></p>
          <p class="card-text mb-4">조회수: <span id="viewCount"></span></p>

        <div class="mt-4 text-center">
            <button class="btn btn-primary" onclick="goList()">목록으로</button>
            <button class="btn btn-warning"
                    th:if="${#authentication.name == board.writer}"
                    onclick="goWrite()">
                수정하기
            </button>
            <button class="btn btn-danger"
                    th:if="${#authentication.name == board.writer}"
                    onclick="deleteBoard()">
                삭제하기
            </button>
          </div>
        </div>
      </div>

      <!-- 버튼들 (기존 코드 유지) -->

<!--        댓글 작성 -->
        <div class="card mt-5 px-4" sec:authorize="isAuthenticated()">
            <div class="card-body">
                <h5 class="card-title mb-3">댓글 입력</h5>
                <form>
                    <div class="mb-3">
                        <textarea id="commentContent" name="commentContent"
                                  class="form-control"
                                  rows="4"
                                  placeholder="댓글을 입력해 주세요."
                                  onkeyup="countingLength(this);"></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="counter">0/300자</small>
                        <button type="button" class="btn btn-success" onclick="saveComment();">댓글 등록</button>
                    </div>
                </form>
            </div>
        </div>

<!--        비로그인 사용자에 대한 댓글 작성에 대한 안내 메시지 출력-->
        <div class="card mt-5 px-4" sec:authorize="isAnonymous()">
            <div class="card-body text-center">
                <h5 class="card-title mb-3">댓글 작성</h5>
                <p class="text-muted mb-0">
                    <a th:href="@{/member/login}" class="text-decoration-none fw-bold">로그인</a> 후 댓글을 작성하실 수 있습니다.
                </p>
            </div>
        </div>

<!--        댓글 렌더링 -->
        <div class="cm_list">
        </div>

<!--        댓글 수정 팝업 -->
        <div id="commentUpdatePopup" class="popLayer" style="display: none;">
            <h3>댓글 수정</h3>
            <div class="pop_container">
                <table class="tb tb_row tl">
                    <colgroup>
                        <col style="width:30%;" /><col style="width:70%;" />
                    </colgroup>
                    <tbody>
                    <tr>
                        <th scope="row">작성자<span class="es">필수 입력</span></th>
                        <td><input type="text" id="modalWriter" name="modalWriter" placeholder="작성자를 입력해 주세요." /></td>
                    </tr>
                    <tr>
                        <th scope="row">내용<span class="es">필수 입력</span></th>
                        <td><textarea id="modalContent" name="modalContent" cols="90" rows="10" placeholder="수정할 내용을 입력해 주세요."></textarea></td>
                    </tr>
                    </tbody>
                </table>
                <p class="btn_set">
                    <button type="button" id="commentUpdateBtn" class="btns btn_st2">수정</button>
                    <button type="button" class="btns btn_bdr2" onclick="closeCommentUpdatePopup();">취소</button>
                </p>
            </div>
            <button type="button" class="btn_close" onclick="closeCommentUpdatePopup();"><span><i class="far fa-times-circle"></i></span></button>
        </div>

<!--        pagination 렌더링-->
        <div class="paging">

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        crossorigin="anonymous">
    </script>
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/function.js}"></script>


    <script th:inline="javascript">
      /*<![CDATA[*/

      const currentUser = /*[[${#authentication.name}]]*/ 'anonymous';

      window.onload = () => {
        findBoard();
        findAllComment();
      }

      /**
       * 게시글 조회
       */
      function findBoard() {

        const id = [[ ${id} ]];

        if (!id) {
          return false;
        }

        fetch(`/api/board/${id}`).then(response => {
          if (!response.ok) {
              // 에러 발생 시, 해당 에러 코드(서버에서 보낸)에 대한 대응 방식
              return response.json().then(error => { throw error });
          }
          return response.json();

        }).then(json => {
            console.table(json);
            json.createdDate = moment(json.createdDate).format('YYYY-MM-DD HH:mm:ss');

            Object.keys(json).forEach(key => {
                const elem = document.getElementById(key);
                if (elem) {
                    elem.innerText = json[key];
                }
            });

            return fetch(`/api/board/${id}/viewCount`, {method: 'POST'});

        }).then(res => {
            if (res.ok) {
                // 4) 화면 조회수 값 +1 반영
                const vcEl = document.getElementById('viewCount');
                vcEl.innerText = Number(vcEl.innerText) + 1;
            } else {
                console.warn('조회수 증가 실패', res.status);
            }

        }).catch(error => {
            if (error.code === "POSTS_ALREADY_DELETED") {
                alert('삭제된 게시글입니다.');
            } else {
                alert('게시글 정보를 찾을 수 없습니다.');
            }
          goList();
        });
      }

      /**
       * 목록으로
       */
      function goList() {
          const id = /*[[ ${id} ]]*/;
          location.href = '/board/list' + location.search;
      }

      /**
       * 수정하기
       */
      function goWrite() {

          const boardId = /*[[${board.id}]]*/;
          const queryString = window.location.search;

          location.href = `/board/write/${boardId}` + queryString;
      }

      /**
       * 삭제하기
       */
      function deleteBoard() {

        const id = [[ ${id} ]];

        if ( !confirm(`게시글을 삭제할까요?`) ) {
          return false;
        }

        fetch(`/api/board/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },

        }).then(response => {
          if (!response.ok) {
            throw new Error('Request failed...');
          }

          alert('삭제되었습니다.');
          goList();

        }).catch(error => {
          alert('오류가 발생하였습니다.');
        });
      }

      /**
       * 댓글 입력 유효성 검사
       * @param textareaElem
       * @param label
       */
      function isValid(textareaElem, label) {
          if (!textareaElem.value.trim()) {
              alert(`${label}을(를) 입력해 주세요.`);
              textareaElem.focus();
              return false;
          }
          return true;
      }

      /**
       * 댓글 길이 카운트
       */
      function countingLength(commentContent) {
          if (commentContent.value.length > 300) {
              alert('300자 이하로 입력해주세요.');
              commentContent.value = commentContent.value.substring(0, 300);
              commentContent.focus();
          }
          document.getElementById('counter').innerText = commentContent.value.length + '/300자';
      }

      /**
       * 댓글 작성(저장)
       */
      function saveComment() {

          const commentContent = document.getElementById('commentContent')
          if (!isValid(commentContent, '댓글')) {
              return;
          }


          const boardId = [[ ${board.id} ]];
          const uri = `/board/${boardId}/comments`;

          const params = {
              boardId : boardId,
              commentContent : commentContent.value
          }

          callApi(uri, 'post', params);
          alert('댓글이 작성되었습니다.');
          content.value = '';
          document.getElementById('commentContent').value = ''; // 댓글 입력창 초기화
          document.getElementById('counter').innerText = '0/300자'; // 댓글 길이 카운팅 초기화
          findAllComment(); // 댓글 작성 완료 후 새로 작성된 댓글 리스트 출력
      }

      // 댓글 HTML 렌더링
      function drawComments(list) {

          if (!list.length) {
              document.querySelector('.cm_list').innerHTML = '<div class="cm_none"><p>등록된 댓글이 없습니다.</p></div>';

              return false;
          }

                  // 렌더링 할 HTML에 대한 변수
          let commentHtml = '';

          list.forEach(row => {
              commentHtml += `
                  <div>
                    <div>
                      <span class="writer_img"><img src="/images/default_profile.png" width="30" height="30"/></span>
                      <span class="writer"><em>${row.writer}</em>
                        <span class="date">${dayjs(row.createdDate).format('YYYY-MM-DD HH:mm')}</span>
                      </span>
                    </div>
                    <div class="cont"><div class="txt_con">${row.commentContent}</div></div>
                    ${row.writer === currentUser
                              ? `<p class="func_btns">
                           <button type="button" onclick="openCommentUpdatePopup(${row.id})" class="btns">수정</button>
                           <button type="button" onclick="deleteComment(${row.id})" class="btns">삭제</button>
                         </p>`
                              : ``
                          }
                  </div>
                `;
          });

          document.querySelector('.cm_list').innerHTML = commentHtml;
      }

      // 댓글 조회 (전체)
      function findAllComment(page) {

          const currentPage = document.querySelector('.paging a.on');
          page = (page) ? page : (currentPage ? Number(currentPage.text) : 1);

          const boardId = [[ ${board.id}]];
          const uri = `/board/${boardId}/comments`;
          const params = {
              page : page,
              boardPerPage : 5,
              pageSize : 10,
              boardId : boardId,
          }

          const response = getJson(uri, params);
          const pagination = response.pagination;
          drawComments(response.list);
          drawPage(pagination, page);
      }

      function updateComment(id) {

          const writer = document.getElementById('modalWriter');
          const content = document.getElementById('modalContent');
          isValid(writer, '작성자');
          isValid(content, '수정할 내용');

          const boardId = [[ ${board.id}]];
          const uri = `/board/${boardId}/comments/${id}`;

          const params = {
              id: id,
              boardId: boardId,
              commentContent: content.value,
              writer: writer.value,
          }

          callApi(uri, 'patch', params);
          alert('댓글이 수정되었습니다.');
          closeCommentUpdatePopup();
          findAllComment();

      }


      // 댓글 수정 팝업 on
      function openCommentUpdatePopup(id) {

          const boardId = [[ ${board.id} ]];
          const uri = `/board/${boardId}/comments/${id}`;
          const response = getJson(uri);

          document.getElementById('modalWriter').value = response.writer;
          document.getElementById('modalContent').value = response.commentContent;
          document.getElementById('commentUpdateBtn').setAttribute('onclick', `updateComment(${id})`);
          layerPop('commentUpdatePopup');
      }


      // 댓글 수정 팝업 close
      function closeCommentUpdatePopup() {
          document.querySelectorAll('#modalContent, #modalWriter').forEach(element => element.value = '');
          document.getElementById('commentUpdateBtn').removeAttribute('onclick');
          layerPopClose('commentUpdatePopup');
      }

      // 댓글 삭제
      function deleteComment(id) {

          if (!confirm('댓글을 삭제하시겠습니까?')) {
              return false;
          }

          const boardId = [[ ${board.id}]];
          const uri = `/board/${boardId}/comments/${id}`;

          callApi(uri, 'delete');
          alert('댓글이 삭제되었습니다.');
          findAllComment();
      }

      // Pagination 렌더링
      function drawPage(pagination, page) {

          // 파라미터가 없는 경우에는 종료
          if ( !pagination || !page ) {
              document.querySelector('.paging').innerHTML = '';
              throw new Error('Missing required parameters...');
          }

          let html = '<div class="btn-group" role="group">';

          // 첫/이전 페이지 버튼
          if (pagination.existPrevPage) {
              html += `
            <button class="btn btn-outline-primary" onclick="findAllComment(1)">« 첫</button>
            <button class="btn btn-outline-primary" onclick="findAllComment(${pagination.startPage - 1})">‹ 이전</button>
        `;
          }

          // 페이지 번호
          for (let i = pagination.startPage; i <= pagination.endPage; i++) {
              const activeClass = i === page ? 'btn-primary' : 'btn-outline-primary';
              html += `<button class="btn ${activeClass}" onclick="findAllComment(${i})">${i}</button>`;
          }

          // 다음/끝 페이지 버튼
          if (pagination.existNextPage) {
              html += `
            <button class="btn btn-outline-primary" onclick="findAllComment(${pagination.endPage + 1})">다음 ›</button>
            <button class="btn btn-outline-primary" onclick="findAllComment(${pagination.totalPageCount})">끝 »</button>
        `;
          }

          html += '</div>';

          // <div class="paging"></div> 태그에 변수 html에 담긴 내용을 렌더링
          const paging = document.querySelector('.paging');
          paging.innerHTML = html;

          // 사용자가 클릭한 페이지 번호(page) 또는 끝 페이지 번호(totalPageCount)에 해당되는 a 태그를 찾아 활성화(active) 처리한 후 클릭 이벤트 제거
          const buttons = Array.from(paging.querySelectorAll('button'));
          const currentBtn = buttons.find(btn => Number(btn.textContent) === page);
          if (currentBtn) {

              currentBtn.classList.remove('btn-outline-primary');
              currentBtn.classList.add('btn-primary');
              currentBtn.disabled = true;
          }
      }


      /*]]>*/
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  </body>
</html>