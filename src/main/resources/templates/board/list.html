<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common :: head('게시글 목록')}">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary" th:replace="~{fragments/common :: menu}"></nav>

<div class="container mt-5">
  <h2 class="text-center mb-4">게시글 목록</h2>
  <table class="table table-striped">
    <thead>
    <tr>
      <th>번호</th>
      <th>제목</th>
      <th>작성자</th>
      <th>등록일</th>
      <th>조회수</th>
    </tr>
    </thead>
    <tbody id="list">
    <!-- JavaScript에서 동적 렌더링 -->
    </tbody>
  </table>

  <!-- 게시글 작성 페이지로 이동하는 버튼 -->
  <div class="d-flex justify-content-end mt-3">
    <a th:href="@{/board/write}" class="btn btn-primary">게시글 작성</a>
  </div>

  <!-- Pagination 렌더링 -->
  <nav aria-label="Page navigation" class="text-center">
    <ul class="pagination justify-content-center">

    </ul>
  </nav>

  <!-- 검색 영역 -->
  <form id="searchForm" onsubmit="return false;" class="d-flex justify-content-center mt-3">
    <div class="input-group" style="max-width: 500px;">
      <select id="searchType" class="form-select" style="max-width: 100px;">
        <option value="">전체</option>
        <option value="title">제목</option>
        <option value="content">내용</option>
        <option value="writer">작성자</option>
      </select>
      <input type="text" id="keyword" class="form-control" placeholder="검색어 입력" />
      <button type="button" onclick="findAll(1);" class="btn btn-primary">
        검색
      </button>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

<script th:inline="javascript">
  /*<![CDATA[*/

  /**
   * 페이지 로딩 시점에 실행되는 함수
   */
  window.onload = () => {
    setQueryStringParams();
    findAll();
    addEnterSearchEvent();
  }

  /**
   * 키워드 - 엔터 검색 이벤트 바인딩
   */
  function addEnterSearchEvent() {

    document.getElementById('keyword').addEventListener('keyup', (e) => {
      if (e.keyCode === 13) {
        findAll(1);
      }
    });
  }

  /**
   * 조회 API 호출
   */
  async function getJson(uri, params) {

    if (params) {
      uri = uri + '?' + new URLSearchParams(params).toString();
    }

    const response = await fetch(uri);

    if (!response.ok) {
      await response.json().then(error => {
        throw error;
      });
    }

    return await response.json();
  }

  /**
   * 게시글 리스트 조회
   */
  function findAll(page) {

    const pageParam = Number(new URLSearchParams(location.search).get('page'));
    page = (page) ? page : ((pageParam) ? pageParam : 1);

    const form = document.getElementById('searchForm');
    const params = {
      page: page
      , boardPerPage: 10
      , pageSize: 10
      , searchType: form.searchType.value
      , searchWord: form.keyword.value
    }

    const queryString = new URLSearchParams(params).toString();
    const replaceUri = location.pathname + '?' + queryString;
    history.replaceState( {}, '', replaceUri);

    getJson('/api/board', params).then(response => {
      if (!Object.keys(response).length) {
        document.getElementById('list').innerHTML = '<td colspan="5">등록된 게시글이 없습니다.</td>';
        drawPages();
        return false;
      }

      let html = '';
      let num = response.params.pagination.totalBoardCount - ((response.params.page - 1) * response.params.boardPerPage);

      response.list.forEach((obj, idx) => {

        const viewUri = `/board/view/${obj.id}` + '?' + queryString;

        html += `
       				<tr>
  						<td>${num--}</td>
  						<td class="text-left">
  							<a href="${viewUri}" onclick="goView(${obj.id})">${obj.title}</a>
  						</td>
  						<td>${obj.writer}</td>
  						<td>${moment(obj.createdDate).format('YYYY-MM-DD HH:mm:ss')}</td>
  						<td>${obj.viewCount}</td>
       				</tr>
       			`;
      });

      document.getElementById('list').innerHTML = html;
      drawPages(response.params);
    });
  }

  /**
   * 쿼리 스트링 파라미터
   */
  function setQueryStringParams() {
    if (!location.search) {
      return false;
    }

    const form = document.getElementById('searchForm');

    new URLSearchParams(location.search).forEach((value, key) => {
      if (form[key]) {
        form[key].value = value;
      }
    });
  }

  /**
   * 게시글 조회
   */
  function goView(id) {
    location.href = `/board/view/${id}`;
  }

  /**
   * 페이지 HTML 렌더링
   */
  function drawPages(params) {

    if (!params) {
      document.querySelector('.pagination').innerHTML = '';
      return false;
    }

    let html = '';
    const pagination = params.pagination;

    // 첫 페이지, 이전 페이지
    if (pagination.existPrevPage) {
      html += `
      <li class="page-item">
        <a class="page-link" href="javascript:void(0)" onclick="findAll(1)">&laquo;</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="javascript:void(0)" onclick="findAll(${pagination.startPage - 1})">&lsaquo;</a>
      </li>
    `;
    }

    // 페이지 번호
    for (let i = pagination.startPage; i <= pagination.endPage; i++) {
      const active = (i === params.page) ? 'class="active"' : '';
      html += `<li class="page-item${active}"><a class="page-link" href="javascript:void(0)" onclick="findAll(${i})">${i}</a></li>`;
    }

    // 다음 페이지, 마지막 페이지
    if (pagination.existNextPage) {
      html += `
      <li class="page-item">
        <a class="page-link" href="javascript:void(0)" onclick="findAll(${pagination.endPage + 1})">&rsaquo;</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="javascript:void(0)" onclick="findAll(${pagination.totalPageCount})">&raquo;</a>
      </li>
    `;
    }

    document.querySelector('.pagination').innerHTML = html;
  }

  /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>